<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Login</title>

    <!-- Custom fonts for this template-->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="css/sb-admin-2.min.css?v=2" rel="stylesheet">

</head>

<body class="bg-gradient-primary">

    <div class="container">

        <!-- Outer Row -->
        <div class="row justify-content-center">

            <div class="col-xl-10 col-lg-12 col-md-9">

                <div class="card o-hidden border-0 shadow-lg my-5">
                    <div class="card-body p-0">
                        <!-- Nested Row within Card Body -->
                        <div class="row">
                            <!-- Left column: centered icon -->
                            <div class="col-lg-6 d-none d-lg-flex bg-login-image" style="align-items: center; justify-content: center; background-color: transparent;">
                                <img src="https://cdn-icons-png.flaticon.com/512/13/13973.png" alt="Icono" style="width:160px; height:160px; object-fit:contain; opacity:0.95;">
                            </div>

                            <div class="col-lg-6">
                                <div class="p-5">
                                    <div class="text-center">
                                        <h1 class="h4 text-gray-900 mb-4">BIENVENIDO DE VUELTA!</h1>
                                    </div>
                                    <form class="user" id="loginForm">
                                        <div class="form-group">
                                            <input type="text" class="form-control form-control-user"
                                                id="username" name="username" required
                                                placeholder="Nombre de Usuario">
                                        </div>
                                        <div class="form-group">
                                            <input type="password" class="form-control form-control-user"
                                                id="password" name="password" required
                                                placeholder="Contraseña">
                                        </div>
                                        <div id="loginMessage" class="alert alert-danger" style="display: none;">
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-user btn-block">
                                            Iniciar Sesión
                                        </button>
                                    </form>
                                    <hr>
                                    <div class="text-center">
                                        <a class="small" href="forgot-password.html">Forgot Password?</a>
                                    </div>
                                    <div class="text-center">
                                        <a class="small" href="register.html">Create an Account!</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <script>
                            (function(){
                                try{
                                    // Only attempt redirects if client has an 'isLoggedIn' flag.
                                    var isLogged = localStorage.getItem('isLoggedIn') === 'true';
                                    if(!isLogged) return; // not authenticated in client storage -> show login page

                                    // If client thinks it's logged, verify server-side session quickly to avoid stale localStorage causing redirects.
                                    // This uses the existing PHP endpoint `php/check_session.php` which returns JSON { loggedIn: true/false, usuario: {...} }
                                    var xhr = new XMLHttpRequest();
                                    xhr.open('GET', 'php/check_session.php', true);
                                    xhr.onreadystatechange = function() {
                                        if(xhr.readyState !== 4) return;
                                        try{
                                            if(xhr.status === 200){
                                                var resp = {};
                                                try { resp = JSON.parse(xhr.responseText || '{}'); } catch(e){ resp = {}; }
                                                if(resp.loggedIn){
                                                    var role = (resp.usuario && resp.usuario.rol) ? resp.usuario.rol.toString().trim().toLowerCase() : (localStorage.getItem('userRoleNormalized') || '').toString().trim().toLowerCase();
                                                    // Update localStorage with server truth to keep client and server consistent
                                                    if(resp.usuario){
                                                        localStorage.setItem('userRole', resp.usuario.rol || '');
                                                        localStorage.setItem('userRoleNormalized', (resp.usuario.rol || '').toString().toLowerCase());
                                                        localStorage.setItem('userDepartment', resp.usuario.departamento || '');
                                                        localStorage.setItem('isLoggedIn', 'true');
                                                    }
                                                    // Now apply redirect rules based on server role
                                                    if(role === 'administrador') return;
                                                    if(role === 'cliente'){
                                                        if(window.location.pathname.toLowerCase().indexOf('/cliente/') === -1){
                                                            window.location.href = 'Cliente/index.php';
                                                            return;
                                                        }
                                                    }
                                                    if(role === 'usuario'){
                                                        var userLink = document.querySelector('#accordionSidebar a.nav-link[href="usuarios.html"]');
                                                        if(userLink){ var li = userLink.closest('li'); if(li) li.style.display = 'none'; else userLink.style.display = 'none'; }
                                                        return;
                                                    }
                                                    // other roles: keep current page (login) or implement other redirects if needed
                                                } else {
                                                    // server says not logged in -> clear client flags to avoid stale redirects
                                                    localStorage.removeItem('isLoggedIn');
                                                    // do not redirect; user stays on login
                                                }
                                            } else {
                                                // on error, prefer to NOT redirect (fail-safe)
                                                localStorage.removeItem('isLoggedIn');
                                            }
                                        }catch(e){
                                            // parsing error or other -> clear and do nothing
                                            localStorage.removeItem('isLoggedIn');
                                        }
                                    };
                                    xhr.send();
                                }catch(e){
                                    // if anything breaks, don't redirect
                                    try{ localStorage.removeItem('isLoggedIn'); }catch(ignore){}
                                }
                            })();
                        </script>
            </div>

        </div>

    </div>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

    <script>
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');
            
            messageDiv.style.display = 'block';
            messageDiv.className = 'alert alert-info';
            messageDiv.textContent = 'Iniciando sesión...';

            // Enviar datos al servidor usando AJAX
            $.ajax({
                url: 'php/login.php',
                type: 'POST',
                data: {
                    username: username,
                    password: password
                },
                dataType: 'json', // Especificar que esperamos JSON
                success: function(data) {
                    console.log('Respuesta del servidor:', data);
                    
                    if (data.success) {
                        // Login exitoso
                        messageDiv.className = 'alert alert-success';
                        messageDiv.textContent = 'Login exitoso. Redirigiendo...';

                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('userName', data.usuario.Nombre);
                        // Guardar rol y versión normalizada
                        var rol = (data.usuario.rol || '').toString();
                        localStorage.setItem('userRole', rol);
                        localStorage.setItem('userRoleNormalized', rol.toLowerCase());
                        localStorage.setItem('userDepartment', data.usuario.departamento);

                        setTimeout(() => {
                            var roleNorm = (localStorage.getItem('userRoleNormalized') || '').toLowerCase();
                            if (roleNorm === 'administrador') {
                                window.location.href = 'usuarios.html';
                            } else if (roleNorm === 'cliente') {
                                window.location.href = 'Cliente/clientesperfil.html';
                            } else {
                                // Default area for other authenticated users
                                window.location.href = 'clientes.html';
                            }
                        }, 800);
                    } else {
                        // Login fallido
                        messageDiv.className = 'alert alert-danger';
                        messageDiv.textContent = data.message || 'Usuario o contraseña incorrectos';
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error de AJAX:', status, error); // Para depuración
                    messageDiv.className = 'alert alert-danger';
                    messageDiv.textContent = 'Error de conexión al servidor: ' + error;
                }
            });
        });
    </script>
    <script>
        (function(){
            try{
                // Only run role-based redirects / UI hiding when the user is logged in.
                var isLogged = localStorage.getItem('isLoggedIn') === 'true';
                if(!isLogged) return; // not authenticated in client storage -> show login page

                var role = localStorage.getItem('userRole') || '';
                var roleNorm = (localStorage.getItem('userRoleNormalized') || role).toString().trim().toLowerCase();
                if(roleNorm === 'administrador') return;
                if(roleNorm === 'cliente'){
                    if(window.location.pathname.toLowerCase().indexOf('/cliente/') === -1){
                        window.location.href = 'Cliente/clientesperfil.html';
                        return;
                    }
                }
                if(roleNorm === 'usuario'){
                    var userLink = document.querySelector('#accordionSidebar a.nav-link[href="usuarios.html"]');
                    if(userLink){
                        var li = userLink.closest('li');
                        if(li) li.style.display = 'none'; else userLink.style.display = 'none';
                    }
                    return;
                
                }
                var userLink = document.querySelector('#accordionSidebar a.nav-link[href="usuarios.html"]');
                if(userLink){ if(userLink.parentElement) userLink.parentElement.style.display = 'none'; else userLink.style.display = 'none'; }
            }catch(e){ }
        })();
    </script>

</body>

</html>