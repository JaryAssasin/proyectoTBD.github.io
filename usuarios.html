    <!DOCTYPE html>
    <html lang="es">

    <head>
        <meta charset="utf-8">
        <title>Usuarios - SB Admin 2</title>

        <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Nunito:400,700&display=swap" rel="stylesheet">
        <link href="css/sb-admin-2.min.css?v=2" rel="stylesheet">
        <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
    </head>

    <body id="page-top">

        <script>
            // Early role class on <html> to allow CSS-based hiding before DOM scripts run
            (function(){
                var role = localStorage.getItem('userRole');
                var roleNormalized = localStorage.getItem('userRoleNormalized') || (role || '').toString().trim().toLowerCase();
                if (roleNormalized) {
                    try { document.documentElement.classList.add('role-' + roleNormalized); } catch(e){}
                }
                if (!localStorage.getItem('isLoggedIn')) {
                    window.location.href = 'index.html';
                }
            })();
        </script>
        <style>
            /* Only hide the Usuarios link when the logged role is 'usuario' */
                .role-usuario #accordionSidebar a.nav-link[href="usuarios.html"] {
                    display: none !important;
                }
        </style>
        <script>
            // Role-based UI + Mobile Sidebar Toggle + Nav highlighting: todo en un DOMContentLoaded
            document.addEventListener('DOMContentLoaded', function () {
                // If the current user is not an administrator, block access to this page
                var role = localStorage.getItem('userRole');
                var roleNormalized = localStorage.getItem('userRoleNormalized') || (role || '').toString().trim().toLowerCase();
                if (roleNormalized && roleNormalized !== 'administrador') {
                    if (roleNormalized === 'cliente') {
                        // Clientes go to the Cliente area
                        window.location.href = 'Cliente/Clientescatalogo.php';
                        return;
                    } else {
                        // Other non-admins redirected to main index
                        window.location.href = 'index.html';
                        return;
                    }
                }
                // Role-based access control
                var role = localStorage.getItem('userRole');
                var roleNormalized = localStorage.getItem('userRoleNormalized') || (role || '').toString().trim().toLowerCase();
                if (roleNormalized) {
                    // Administrador stays on this page (Usuarios). Do not redirect to another area.
                    if (roleNormalized === 'usuario') {
                        var links = document.querySelectorAll('#accordionSidebar a.nav-link[href="maestros.html"], #accordionSidebar a.nav-link[href="usuarios.html"]');
                        links.forEach(function (a) {
                            var li = a.closest('li');
                            if (li) li.style.display = 'none';
                        });
                    }
                }

                // Mobile Sidebar Toggle
                var mobileToggle = document.getElementById('sidebarToggleMobile');
                if (mobileToggle) {
                    mobileToggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        var sidebar = document.getElementById('accordionSidebar');
                        if (sidebar) {
                            sidebar.classList.toggle('toggled');
                        }
                    });
                }

                // Mark current nav item as active
                var currentPage = window.location.pathname.split('/').pop() || 'alumnos.html';
                var navItems = document.querySelectorAll('#accordionSidebar .nav-item');
                navItems.forEach(function (item) {
                    var link = item.querySelector('a.nav-link');
                    if (link && link.getAttribute('href') === currentPage) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            });
        </script>

        <div id="wrapper">
            <!-- Sidebar -->
            <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
                <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
                    <div class="sidebar-brand-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="sidebar-brand-text mx-3">USUARIOS</div>
                </a>

                <hr class="sidebar-divider">
                <!-- Nav Item - Alumnos -->
                <li class="nav-item active">
                    <a class="nav-link" href="clientes.html">
                        <i class="fas fa-user-graduate"></i>
                        <span>Clientes</span>
                    </a>
                </li>

                <!-- Nav Item - Maestros -->
                <li class="nav-item">
                    <a class="nav-link" href="videojuegos.html">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>Videojuegos</span>
                    </a>
                </li>

                <!-- Nav Item - Materias -->
                <li class="nav-item">
                    <a class="nav-link" href="compañias.html">
                        <i class="fas fa-book"></i>
                        <span>Compañias</span>
                    </a>
                </li>

                <!-- Nav Item - Usuarios -->
                <li class="nav-item">
                    <a class="nav-link" href="pedidos.html">
                        <i class="fas fa-user"></i>
                        <span>Pedidos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="usuarios.html">
                        <i class="fas fa-user"></i>
                        <span>Usuarios</span>
                    </a>
                </li>


                <hr class="sidebar-divider d-none d-md-block">
            </ul>

            <!-- Contenido principal -->
            <div id="content-wrapper" class="d-flex flex-column">
                <div id="content" class="p-4">
                    <!-- Sidebar Toggle Button (Mobile) -->
                    <button id="sidebarToggleMobile" class="btn btn-link d-md-none mb-3">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>

                    <h1 class="h3 mb-4 text-gray-800">Usuarios</h1>
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">Lista de Usuarios</h6>
                            <button class="btn btn-primary" data-toggle="modal" data-target="#modalCrearUsuario">
                                <i class="fas fa-user-plus"></i> Crear Usuario
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="tablaUsuarios" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nombre Usuario</th>
                                            <th>Nombre</th>
                                            <th>Rol</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <footer class="sticky-footer bg-white">
                    <div class="container my-auto text-center">
                        <span>© Sistema Usuarios 2025</span>
                    </div>
                </footer>
            </div>
        </div>

        <!-- Modal Crear Usuario -->
        <div class="modal fade" id="modalCrearUsuario" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <form id="formCrearUsuario">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Crear Usuario</h5>
                            <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Nombre Usuario</label>
                                <input type="text" class="form-control" name="nombreUsuario" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre Completo</label>
                                <input type="text" class="form-control" name="Nombre" required>
                            </div>
                            <div class="form-group">
                                <label>Contraseña</label>
                                <input type="password" class="form-control" name="contraseña" required>
                            </div>
                            <div class="form-group">
                                <label>Rol</label>
                                <select class="form-control" name="rol" required>
                                    <option value="">Seleccione...</option>
                                    <option value="Administrador">Administrador</option>
                                    <option value="Alumno">Alumno</option>
                                    <option value="Docente">Docente</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Editar Usuario -->
        <div class="modal fade" id="modalEditarUsuario" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <form id="formEditarUsuario">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Editar Usuario</h5>
                            <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="idUsuario" id="edit_idUsuario">
                            <div class="form-group">
                                <label>Nombre Usuario</label>
                                <input type="text" class="form-control" name="nombreUsuario" id="edit_nombreUsuario"
                                    required>
                            </div>
                            <div class="form-group">
                                <label>Nombre Completo</label>
                                <input type="text" class="form-control" name="Nombre" id="edit_Nombre" required>
                            </div>
                            <div class="form-group">
                                <label>Contraseña</label>
                                <input type="password" class="form-control" name="contraseña" id="edit_contraseña" required>
                            </div>
                            <div class="form-group">
                                <label>Rol</label>
                                <select class="form-control" name="rol" id="edit_rol" required>
                                    <option value="Administrador">Administrador</option>
                                    <option value="Alumno">Alumno</option>
                                    <option value="Docente">Docente</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Departamento</label>
                                <input type="text" class="form-control" name="departamento" id="edit_departamento">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Actualizar</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Scripts -->
        <script src="vendor/jquery/jquery.min.js"></script>
        <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="vendor/datatables/jquery.dataTables.min.js"></script>
        <script src="vendor/datatables/dataTables.bootstrap4.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script>
            $(document).ready(function () {
                var tabla = $('#tablaUsuarios').DataTable({
                    "ajax": "php/obtener_usuarios.php",
                    // Forzar mostrar todos los registros por defecto
                    "pageLength": -1,
                    "lengthMenu": [[-1, 10, 25, 50], ["Todos", 10, 25, 50]],
                    "columns": [
                        { "data": "idUsuario" },
                        { "data": "nombreUsuario" },
                        { "data": "Nombre" },
                        { "data": "rol" },
                        {
                            "data": null,
                            "render": function (data) {
                                return `
                        <button class="btn btn-warning btn-sm btn-editar" data-id="${data.idUsuario}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm btn-eliminar" data-id="${data.idUsuario}">
                            <i class="fas fa-trash"></i>
                        </button>`;
                            }
                        }
                    ]
                });


                // Crear usuario
                $('#formCrearUsuario').on('submit', function (e) {
                    e.preventDefault();
                    $.post('php/insertar_usuario.php', $(this).serialize(), function (res) {
                        if (res.status === "ok") {
                            $('#modalCrearUsuario').modal('hide');
                            tabla.ajax.reload();
                            Swal.fire('Éxito', res.msg, 'success');
                        } else {
                            Swal.fire('Error', res.msg, 'error');
                        }
                    }, 'json');
                });

                // Editar usuario (cargar datos)
                $('#tablaUsuarios').on('click', '.btn-editar', function () {
                    var data = tabla.row($(this).parents('tr')).data();
                    $('#edit_idUsuario').val(data.idUsuario);
                    $('#edit_nombreUsuario').val(data.nombreUsuario);
                    $('#edit_Nombre').val(data.Nombre);
                    $('#edit_contraseña').val(data.contraseña);
                    $('#edit_rol').val(data.rol);
                    $('#edit_departamento').val(data.departamento);
                    $('#modalEditarUsuario').modal('show');
                });

                // Actualizar usuario
                $('#formEditarUsuario').on('submit', function (e) {
                    e.preventDefault();
                    $.post('php/editar_usuario.php', $(this).serialize(), function (res) {
                        if (res && res.status === "ok") {
                            $('#modalEditarUsuario').modal('hide');
                            tabla.ajax.reload();
                            Swal.fire('Actualizado', 'Usuario modificado', 'success');
                        } else {
                            var msg = (res && res.msg) ? res.msg : 'No se pudo actualizar';
                            Swal.fire('Error', msg, 'error');
                            console.error('Editar usuario error:', res && res.error ? res.error : res);
                        }
                    }, 'json').fail(function (xhr, status, err) {
                        Swal.fire('Error', 'Respuesta inválida del servidor', 'error');
                        console.error('Editar usuario request failed:', status, err, xhr.responseText);
                    });
                });

                // Eliminar usuario
                $('#tablaUsuarios').on('click', '.btn-eliminar', function () {
                    let id = $(this).data('id');
                    Swal.fire({
                        title: '¿Eliminar usuario?',
                        text: 'Esta acción no se puede deshacer.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, eliminar',
                        cancelButtonText: 'Cancelar'
                    }).then((r) => {
                        if (r.isConfirmed) {
                            $.post('php/eliminar_usuario.php', { idUsuario: id }, function (res) {
                                if (res === "ok") {
                                    tabla.ajax.reload();
                                    Swal.fire('Eliminado', 'Usuario borrado correctamente', 'success');
                                } else {
                                    Swal.fire('Error', 'No se pudo eliminar', 'error');
                                }
                            });
                        }
                    });
                });
            });
        </script>
    </body>

    </html>